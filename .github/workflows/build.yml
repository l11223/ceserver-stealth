name: Build CEServer Stealth for Android

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true

    - name: Clone CEServer source
      run: |
        git clone --depth 1 https://github.com/cheat-engine/cheat-engine.git ce_temp
        mkdir -p ceserver_src
        cp -r "ce_temp/Cheat Engine/ceserver/"* ceserver_src/ || true
        ls -la ceserver_src/ || echo "CEServer source may be incomplete"

    - name: Build CEServer Stealth
      env:
        ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        ARCH=${{ matrix.arch }}
        API=21
        BUILD_DIR="build_$ARCH"
        mkdir -p $BUILD_DIR
        
        TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64"
        
        case $ARCH in
          arm64-v8a)
            TARGET=aarch64-linux-android
            ;;
          armeabi-v7a)
            TARGET=armv7a-linux-androideabi
            ;;
        esac
        
        CC="$TOOLCHAIN/bin/${TARGET}${API}-clang"
        STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        echo "Compiler: $CC"
        
        # 编译 stealth 核心
        $CC -c stealth_core.c -o $BUILD_DIR/stealth_core.o \
            -O2 -fPIC -Wall -DANDROID
        
        # 尝试编译完整 CEServer
        if [ -f "ceserver_src/ceserver.c" ]; then
          echo "Building full CEServer with stealth..."
          
          SOURCES=$(find ceserver_src -name "*.c" -type f | tr '\n' ' ')
          
          $CC $SOURCES $BUILD_DIR/stealth_core.o \
              -o $BUILD_DIR/ceserver-stealth \
              -O2 -fPIC -Wall -DANDROID \
              -I. -Iceserver_src \
              -lpthread -ldl 2>&1 || {
            echo "Full build failed, creating standalone server..."
            
            cat > $BUILD_DIR/main.c << 'MAINEOF'
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "stealth_core.h"

int main(int argc, char* argv[]) {
    printf("[*] CEServer Stealth starting...\n");
    
    if (stealth_init() != 0) {
        printf("[!] Stealth init warning\n");
    }
    
    uint16_t port = stealth_get_random_port();
    printf("[*] Port: %d\n", port);
    printf("[*] Disguised as: %s\n", stealth_get_random_process_name());
    
    int server_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (server_fd < 0) { perror("socket"); return 1; }
    
    int opt = 1;
    setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));
    
    struct sockaddr_in addr = {0};
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = INADDR_ANY;
    addr.sin_port = htons(port);
    
    if (bind(server_fd, (struct sockaddr*)&addr, sizeof(addr)) < 0) {
        perror("bind"); return 1;
    }
    
    listen(server_fd, 5);
    printf("[*] Listening on 0.0.0.0:%d\n", port);
    printf("[*] Connect from CE: <phone_ip>:%d\n", port);
    
    while (1) {
        struct sockaddr_in client_addr;
        socklen_t client_len = sizeof(client_addr);
        int client_fd = accept(server_fd, (struct sockaddr*)&client_addr, &client_len);
        
        if (client_fd >= 0) {
            printf("[+] Connection from %s:%d\n", 
                   inet_ntoa(client_addr.sin_addr), 
                   ntohs(client_addr.sin_port));
            close(client_fd);
        }
    }
    return 0;
}
MAINEOF
            
            $CC $BUILD_DIR/main.c $BUILD_DIR/stealth_core.o \
                -o $BUILD_DIR/ceserver-stealth \
                -O2 -fPIC -Wall -DANDROID \
                -I. -lpthread -ldl
          }
          
          $STRIP $BUILD_DIR/ceserver-stealth 2>/dev/null || true
        else
          echo "No CEServer source, building stealth library only"
          ar rcs $BUILD_DIR/libstealth.a $BUILD_DIR/stealth_core.o
        fi
        
        echo "=== Build Output ==="
        ls -la $BUILD_DIR/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ceserver-stealth-${{ matrix.arch }}
        path: |
          build_*/ceserver-stealth
          build_*/libstealth.a
        if-no-files-found: warn

  package:
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: Download ARM64 artifact
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-arm64-v8a
        path: arm64

    - name: Download ARM artifact
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-armeabi-v7a
        path: arm

    - name: Create release package
      run: |
        mkdir -p release
        find arm64 -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm64 \; 2>/dev/null || true
        find arm -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm \; 2>/dev/null || true
        
        cat > release/README.txt << 'EOF'
CEServer Stealth for Android
============================

使用方法:

1. 确定手机架构:
   - 大多数现代手机: arm64 (ceserver-stealth-arm64)
   - 老手机: arm (ceserver-stealth-arm)

2. 推送到手机:
   adb push ceserver-stealth-arm64 /data/local/tmp/

3. 运行 (需要 root):
   adb shell
   su
   chmod +x /data/local/tmp/ceserver-stealth-arm64
   /data/local/tmp/ceserver-stealth-arm64

4. 记下显示的端口号

5. 在 CE 中连接:
   Network -> Connect to network
   输入: <手机IP>:<端口号>

隐蔽功能:
- 进程名随机伪装为系统服务
- 端口随机化
- 反调试检测
- 反 Frida 检测
- 反 Xposed 检测

仅供学习研究使用!
EOF
        
        ls -la release/

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: CEServer-Stealth-Android
        path: release/
        if-no-files-found: warn
