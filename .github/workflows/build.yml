name: Build CEServer Stealth for Android

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64, arm]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Find NDK
      run: |
        if [ -d "$ANDROID_NDK_HOME" ]; then
          echo "ANDROID_NDK=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        elif [ -d "$ANDROID_NDK_ROOT" ]; then
          echo "ANDROID_NDK=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        else
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -type d | head -2 | tail -1)
          echo "ANDROID_NDK=$NDK_PATH" >> $GITHUB_ENV
        fi

    - name: Clone and patch CEServer source
      run: |
        git clone --depth 1 https://github.com/cheat-engine/cheat-engine.git ce_repo
        cp -r "ce_repo/Cheat Engine/ceserver" src
        
        cp stealth_core.c src/
        cp stealth_core.h src/
        cp stealth_config.h src/
        
        cd src
        
        # 补丁1: api.c 函数指针
        sed -i 's/write_v=process_vm_writev2;/write_v=(PROCESS_VM_WRITEV)process_vm_writev2;/g' api.c
        sed -i 's/readv=process_vm_readv2;/readv=(PROCESS_VM_READV)process_vm_readv2;/g' api.c
        
        # 补丁2: sigaction
        sed -i 's/sigaction(SIGPIPE.*SIG_IGN.*NULL);/signal(SIGPIPE, SIG_IGN);/g' ceserver.c
        
        # 补丁3: porthelp.c debug_log 声明
        sed -i '1i extern void debug_log(const char* fmt, ...);' porthelp.c
        
        # 补丁4: 删除测试文件
        rm -f ceservertest.c
        
        # 补丁5: 添加 stealth 初始化
        sed -i '1i #include "stealth_core.h"' ceserver.c
        awk '/int main\(int argc/{found=1} found && /{/{print; print "  stealth_init();"; found=0; next} 1' ceserver.c > ceserver_tmp.c
        mv ceserver_tmp.c ceserver.c
        
        # 补丁6: 创建 stub 文件
        echo '#include <stdint.h>' > stubs.c
        echo '#include <stddef.h>' >> stubs.c
        echo 'int ext_loadModuleEx(void* p1, void* p2, void* p3) { return 0; }' >> stubs.c
        echo 'int ext_loadModule(void* p1, void* p2) { return 0; }' >> stubs.c
        echo 'void ext_free(void* p) {}' >> stubs.c
        echo 'int ext_changememoryprotection(void* p1, size_t s, int prot) { return 0; }' >> stubs.c
        echo 'int ext_createThread(void* p1, void* p2) { return 0; }' >> stubs.c
        echo 'void* ext_alloc(void* p1, size_t s) { return NULL; }' >> stubs.c
        echo 'int ext_speedhack_setSpeed(float speed) { return 0; }' >> stubs.c
        echo 'int handleGetOption(void* p1) { return 0; }' >> stubs.c
        echo 'int handleGetOptions(void* p1) { return 0; }' >> stubs.c
        echo 'int handleSetOption(void* p1) { return 0; }' >> stubs.c
        echo 'int loadCEServerExtension(void* p1) { return 0; }' >> stubs.c
        echo 'void* allocWithoutExtension(void* p1, size_t s) { return NULL; }' >> stubs.c
        echo 'void CESERVERTEST(void) {}' >> stubs.c
        echo 'int getContext(int tid, void* ctx) { return -1; }' >> stubs.c
        echo 'int setContext(int tid, void* ctx) { return -1; }' >> stubs.c
        
        echo "=== Patches applied ==="
        head -10 ceserver.c
        cat stubs.c

    - name: Build CEServer with Stealth
      run: |
        ARCH=${{ matrix.arch }}
        API=21
        BUILD_DIR="build_$ARCH"
        mkdir -p $BUILD_DIR
        
        TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64"
        
        case $ARCH in
          arm64)
            TARGET=aarch64-linux-android
            ;;
          arm)
            TARGET=armv7a-linux-androideabi
            ;;
        esac
        
        CC="$TOOLCHAIN/bin/${TARGET}${API}-clang"
        STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        cd src
        
        SOURCES="ceserver.c api.c porthelp.c symbols.c threads.c stealth_core.c stubs.c"
        
        for f in native-api.c; do
          if [ -f "$f" ]; then
            SOURCES="$SOURCES $f"
          fi
        done
        
        echo "=== Compiling: $SOURCES ==="
        
        $CC $SOURCES \
            -o ../$BUILD_DIR/ceserver-stealth \
            -O2 -fPIC -DANDROID \
            -DNO_EXTENSIONS \
            -Wno-error \
            -Wno-implicit-function-declaration \
            -Wno-int-conversion \
            -Wno-incompatible-pointer-types \
            -Wno-incompatible-function-pointer-types \
            -Wno-pointer-bool-conversion \
            -Wno-parentheses \
            -Wno-unused-variable \
            -Wno-unused-but-set-variable \
            -llog -lz -ldl
        
        cd ..
        $STRIP $BUILD_DIR/ceserver-stealth
        
        echo "=== Build Output ==="
        ls -la $BUILD_DIR/
        file $BUILD_DIR/ceserver-stealth

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ceserver-stealth-${{ matrix.arch }}
        path: build_*/ceserver-stealth
        if-no-files-found: error

  package:
    runs-on: ubuntu-latest
    needs: build-android
    if: always()
    
    steps:
    - name: Download ARM64
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-arm64
        path: arm64
      continue-on-error: true

    - name: Download ARM
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-arm
        path: arm
      continue-on-error: true

    - name: Create package
      run: |
        mkdir -p release
        find arm64 -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm64 \; 2>/dev/null || true
        find arm -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm \; 2>/dev/null || true
        echo "CEServer Stealth for Android" > release/README.txt
        echo "Usage: adb push ceserver-stealth-arm64 /data/local/tmp/" >> release/README.txt
        echo "Then: adb shell su -c /data/local/tmp/ceserver-stealth-arm64" >> release/README.txt
        echo "CE connect: phone_ip:52736" >> release/README.txt
        ls -la release/

    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: CEServer-Stealth-Android
        path: release/
        if-no-files-found: warn
