name: Build CEServer Stealth for Android

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true

    - name: Download official CEServer
      run: |
        # 下载官方 CEServer
        wget -q "https://github.com/cheat-engine/cheat-engine/releases/download/7.5/ceserver76.zip" -O ceserver.zip || \
        wget -q "https://www.cheatengine.org/downloads/ceserver76.zip" -O ceserver.zip || true
        
        if [ -f ceserver.zip ]; then
          unzip -o ceserver.zip -d ceserver_official || true
          ls -la ceserver_official/ || true
        fi

    - name: Build Stealth Wrapper
      env:
        ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        ARCH=${{ matrix.arch }}
        API=21
        BUILD_DIR="build_$ARCH"
        mkdir -p $BUILD_DIR
        
        TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64"
        
        case $ARCH in
          arm64-v8a)
            TARGET=aarch64-linux-android
            CESERVER_ARCH="arm64"
            ;;
          armeabi-v7a)
            TARGET=armv7a-linux-androideabi
            CESERVER_ARCH="arm"
            ;;
        esac
        
        CC="$TOOLCHAIN/bin/${TARGET}${API}-clang"
        STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        echo "=== Building Stealth Module ==="
        
        # 编译 stealth 核心 (不用 pthread，Android 用 bionic)
        $CC -c stealth_core.c -o $BUILD_DIR/stealth_core.o \
            -O2 -fPIC -Wall -DANDROID -Wno-unused-function
        
        # 编译独立的 stealth server
        $CC main_standalone.c $BUILD_DIR/stealth_core.o \
            -o $BUILD_DIR/ceserver-stealth \
            -O2 -fPIC -Wall -DANDROID -I. -ldl \
            -Wno-unused-function
        
        $STRIP $BUILD_DIR/ceserver-stealth
        
        # 复制官方 ceserver (如果有)
        if [ -d "ceserver_official" ]; then
          find ceserver_official -name "*$CESERVER_ARCH*" -o -name "ceserver" | while read f; do
            cp "$f" $BUILD_DIR/ 2>/dev/null || true
          done
        fi
        
        echo "=== Build Output ==="
        ls -la $BUILD_DIR/
        file $BUILD_DIR/ceserver-stealth

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ceserver-stealth-${{ matrix.arch }}
        path: build_*/ceserver-stealth
        if-no-files-found: error

  package:
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: Download ARM64 artifact
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-arm64-v8a
        path: arm64

    - name: Download ARM artifact
      uses: actions/download-artifact@v4
      with:
        name: ceserver-stealth-armeabi-v7a
        path: arm

    - name: Create release package
      run: |
        mkdir -p release
        find arm64 -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm64 \; 2>/dev/null || true
        find arm -name "ceserver-stealth" -exec cp {} release/ceserver-stealth-arm \; 2>/dev/null || true
        
        cat > release/README.txt << 'READMEEOF'
        CEServer Stealth for Android
        ============================
        
        使用方法:
        
        1. 确定手机架构:
           - 大多数现代手机: arm64 (ceserver-stealth-arm64)
           - 老手机: arm (ceserver-stealth-arm)
        
        2. 推送到手机:
           adb push ceserver-stealth-arm64 /data/local/tmp/
        
        3. 运行 (需要 root):
           adb shell
           su
           chmod +x /data/local/tmp/ceserver-stealth-arm64
           /data/local/tmp/ceserver-stealth-arm64
        
        4. 记下显示的端口号
        
        5. 在 CE 中连接:
           Network -> Connect to network
           输入: <手机IP>:<端口号>
        
        隐蔽功能:
        - 进程名随机伪装为系统服务
        - 端口随机化 (每次启动不同)
        - 反调试检测
        - 反 Frida 检测
        - 反 Xposed 检测
        
        仅供学习研究使用!
        READMEEOF
        
        ls -la release/

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: CEServer-Stealth-Android
        path: release/
        if-no-files-found: warn
